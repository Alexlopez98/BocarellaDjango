{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ã“rdenes Recibidas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/headerandfooter.css' %}">
  <link rel="stylesheet" href="{% static 'css/pizzas.css' %}">
</head>
<body>

{% include 'header.html' %}

<main class="container my-4">
  <h1 class="text-center mb-4">ðŸ“‹ Ã“rdenes Recibidas</h1>

  <!-- Controles de audio y filtro -->
  <div class="text-center mb-3">
    <button id="toggleAudioBtn" class="btn btn-success me-2">ðŸ”” Sonido Activado</button>

    <button class="btn btn-secondary filtro-estado" data-estado="todas">Todas</button>
    <button class="btn btn-warning filtro-estado" data-estado="pendiente">Pendientes</button>
    <button class="btn btn-primary filtro-estado" data-estado="preparacion">En PreparaciÃ³n</button>
    <button class="btn btn-success filtro-estado" data-estado="lista">Listas</button>
  </div>

  <!-- PestaÃ±as -->
  <ul class="nav nav-tabs mb-3" id="ordenTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="ordenes-tab" data-bs-toggle="tab" data-bs-target="#ordenes" type="button" role="tab">Ã“rdenes</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial" type="button" role="tab">Historial</button>
    </li>
  </ul>

  <div class="tab-content" id="ordenTabsContent">
    <!-- TAB Ã“rdenes -->
    <div class="tab-pane fade show active" id="ordenes" role="tabpanel">
      <p class="text-center fw-bold">Total recibido: ${{ total_recibido }}</p>
      <div class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead class="table-dark">
            <tr>
              <th>ID Orden</th>
              <th>Total</th>
              <th>Items</th>
              <th>Tiempo</th>
              <th>Estado / AcciÃ³n</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- TAB Historial -->
    <div class="tab-pane fade" id="historial" role="tabpanel">
      {% include 'historialempleados.html' %}
    </div>
  </div>
</main>

{% include 'footer.html' %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
let audio = new Audio("{% static 'sounds/bell.mp3' %}");
let audioActivado = true;
let ordenTimestamps = {};
let estadoFiltro = "todas";

// Toggle audio
document.getElementById("toggleAudioBtn").addEventListener("click", () => {
    audioActivado = !audioActivado;
    const btn = document.getElementById("toggleAudioBtn");
    btn.textContent = audioActivado ? "ðŸ”” Sonido Activado" : "ðŸ”• Sonido Bloqueado";
    btn.classList.toggle("btn-success", audioActivado);
    btn.classList.toggle("btn-danger", !audioActivado);
});

// Cambiar filtro
document.querySelectorAll(".filtro-estado").forEach(btn => {
    btn.addEventListener("click", () => {
        estadoFiltro = btn.dataset.estado;
        actualizarOrdenes();
    });
});

function actualizarOrdenes() {
    fetch("{% url 'ordenes_empleados_json' %}?estado=" + estadoFiltro)
        .then(res => res.json())
        .then(data => {
            const tbody = document.querySelector("#ordenes tbody");
            tbody.innerHTML = "";

            let nuevasOrdenes = [];

            data.ordenes.forEach(orden => {
                if (!ordenTimestamps[orden.id]) {
                    ordenTimestamps[orden.id] = true;
                    nuevasOrdenes.push(orden.id);
                }

                let itemsHTML = "<ul>";
                orden.items.forEach(item => {
                    itemsHTML += `<li>${item.nombre} x${item.cantidad} ($${item.subtotal})</li>`;
                });
                itemsHTML += "</ul>";

                const fila = document.createElement("tr");
                fila.innerHTML = `
                    <td>${orden.id}</td>
                    <td>$${orden.total}</td>
                    <td>${itemsHTML}</td>
                    <td>${orden.tiempo_legible}</td>
                    <td>
                        <strong id="estado-${orden.id}">${orden.estado_cocina || "pendiente"}</strong>
                        <button class="btn btn-sm btn-primary ms-2 avanzar-estado" data-id="${orden.id}">Avanzar</button>
                    </td>
                `;
                tbody.appendChild(fila);
            });

            const totalRecibidoElem = document.querySelector("#ordenes p.fw-bold");
            if (totalRecibidoElem) {
                totalRecibidoElem.textContent = `Total recibido: $${data.total_recibido}`;
            }

            if (nuevasOrdenes.length > 0 && audioActivado) audio.play().catch(e => console.log(e));
        })
        .catch(err => console.error(err));
}

// Avanzar estado
document.addEventListener("click", function(e) {
    if (e.target.classList.contains("avanzar-estado")) {
        const id = e.target.dataset.id;
        const estadoElem = document.getElementById(`estado-${id}`);
        let nuevoEstado = { pendiente: "preparacion", preparacion: "lista", lista: "lista" }[estadoElem.textContent.trim()] || "pendiente";

        fetch(`/actualizar_estado_cocina/${id}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ estado: nuevoEstado })
        })
        .then(res => res.json())
        .then(data => {
            if (data.ok) estadoElem.textContent = data.estado;
        })
        .catch(err => console.error(err));
    }
});

setInterval(actualizarOrdenes, 1000);
actualizarOrdenes();
</script>

</body>
</html>
