{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ã“rdenes Recibidas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/headerandfooter.css' %}">
  <link rel="stylesheet" href="{% static 'css/pizzas.css' %}">
</head>
<body>

{% include 'header.html' %}

<main class="container my-4">
  <h1 class="text-center mb-4">ðŸ“‹ Ã“rdenes Recibidas</h1>

  <div class="text-center mb-3">
    <button id="toggleAudioBtn" class="btn btn-success">ðŸ”” Sonido Activado</button>
  </div>

  <p class="text-center fw-bold">Total recibido: ${{ total_recibido }}</p>

  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>ID Orden</th>
          <th>Total</th>
          <th>Items</th>
          <th>Tiempo</th>
          <th>Estado / AcciÃ³n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

{% include 'footer.html' %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
let audio = new Audio("{% static 'sounds/bell.mp3' %}");
let audioActivado = true;
let ordenTimestamps = {};

const toggleBtn = document.getElementById("toggleAudioBtn");
toggleBtn.addEventListener("click", () => {
    audioActivado = !audioActivado;
    if (audioActivado) {
        toggleBtn.textContent = "ðŸ”” Sonido Activado";
        toggleBtn.classList.remove("btn-danger");
        toggleBtn.classList.add("btn-success");
    } else {
        toggleBtn.textContent = "ðŸ”• Sonido Bloqueado";
        toggleBtn.classList.remove("btn-success");
        toggleBtn.classList.add("btn-danger");
    }
});

function actualizarOrdenes() {
    fetch("{% url 'ordenes_empleados_json' %}")
        .then(res => res.json())
        .then(data => {
            const tbody = document.querySelector("table tbody");
            tbody.innerHTML = "";

            let nuevasOrdenes = [];

            data.ordenes.forEach(orden => {
                if (!ordenTimestamps[orden.id]) {
                    ordenTimestamps[orden.id] = true;
                    nuevasOrdenes.push(orden.id);
                }

                let itemsHTML = "<ul>";
                orden.items.forEach(item => {
                    itemsHTML += `<li>${item.nombre} x${item.cantidad} ($${item.subtotal})</li>`;
                });
                itemsHTML += "</ul>";

                const fila = document.createElement("tr");
                fila.innerHTML = `
                    <td>${orden.id}</td>
                    <td>$${orden.total}</td>
                    <td>${itemsHTML}</td>
                    <td>${orden.tiempo_legible}</td>
                    <td>
                        <strong id="estado-${orden.id}">${orden.estado_cocina || "pendiente"}</strong>
                        <button class="btn btn-sm btn-primary ms-2 avanzar-estado" data-id="${orden.id}">Avanzar</button>
                    </td>
                `;
                tbody.appendChild(fila);
            });

            const totalRecibidoElem = document.querySelector("p.fw-bold");
            if (totalRecibidoElem) {
                totalRecibidoElem.textContent = `Total recibido: $${data.total_recibido}`;
            }

            if (nuevasOrdenes.length > 0 && audioActivado) {
                audio.play().catch(e => console.log("Error al reproducir audio:", e));
            }
        })
        .catch(err => console.error("Error al actualizar Ã³rdenes:", err));
}

setInterval(actualizarOrdenes, 5000);
actualizarOrdenes();

// Avanzar estado
document.addEventListener("click", function(e) {
    if (e.target.classList.contains("avanzar-estado")) {
        const id = e.target.dataset.id;
        const estadoElem = document.getElementById(`estado-${id}`);
        let nuevoEstado;

        switch (estadoElem.textContent.trim()) {
            case "pendiente":
                nuevoEstado = "preparacion";
                break;
            case "preparacion":
                nuevoEstado = "lista";
                break;
            case "lista":
                nuevoEstado = "lista"; // se queda en lista
                break;
            default:
                nuevoEstado = "pendiente";
        }

        fetch(`/actualizar_estado_cocina/${id}/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ estado: nuevoEstado })
        })
        .then(res => res.json())
        .then(data => {
            if (data.ok) {
                estadoElem.textContent = data.estado;
            }
        })
        .catch(err => console.error(err));
    }
});
</script>

</body>
</html>
